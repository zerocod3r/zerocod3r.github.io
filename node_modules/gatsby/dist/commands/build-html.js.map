{"version":3,"sources":["../../src/commands/build-html.ts"],"names":["devssrWebpackCompiler","devssrWebpackWatcher","needToRecompileSSRBundle","getDevSSRWebpack","process","env","gatsby_executing_command","Error","oldHash","newHash","runWebpack","compilerConfig","stage","directory","Bluebird","resolve","reject","GATSBY_EXPERIMENTAL_DEV_SSR","run","err","stats","hooks","invalid","tap","file","watch","ignored","emitter","emit","suspend","hash","restartWorker","require","doBuildRenderer","webpackConfig","hasErrors","reporter","panic","compilation","errors","store","getState","html","ssrCompilationHash","dispatch","type","payload","buildRenderer","program","parentSpan","config","deleteRenderer","rendererPath","fs","remove","e","renderHTMLQueue","workerPool","activity","htmlComponentRendererPath","pages","Stage","BuildHTML","envVars","NODE_ENV","gatsby_log_level","segments","sessionId","Date","now","renderHTML","renderHTMLProd","renderHTMLDev","uniqueUnsafeBuiltinUsedStacks","Set","map","pageSegment","htmlRenderMeta","paths","_pagePath","arrayOfUsages","Object","entries","unsafeBuiltinsUsageByPagePath","unsafeUsageStack","add","tick","length","context","size","console","warn","unsafeBuiltinUsedStack","prettyError","warningMessage","stack","codeFrame","BuildHTMLError","constructor","error","message","getOwnPropertyNames","forEach","key","doBuildPages","pagePaths","buildError","buildHTML","span","buildHTMLPagesAndDeleteStaleArtifacts","pageRenderer","buildSpan","buildUtils","markHtmlDirtyIfResultOfUsedStaticQueryChanged","toRegenerate","toDelete","toCleanupFromTrackedState","calcDirtyHtmlFiles","buildHTMLActivityProgress","createProgress","start","id","errorPath","path","ref","match","end","info","keepPageRenderer","publicDir","join","deletePageDataActivityTimer","activityTimer","removePageFiles"],"mappings":";;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AAEA;;AACA;;AACA;;AAGA;;AAmBA,IAAIA,qBAAJ;AACA,IAAIC,oBAAJ;AACA,IAAIC,wBAAwB,GAAG,IAA/B;;AACO,MAAMC,gBAAgB,GAAG,MAI3B;AACH,MAAIC,OAAO,CAACC,GAAR,CAAYC,wBAAZ,KAA0C,SAA9C,EAAwD;AACtD,UAAM,IAAIC,KAAJ,CAAW,iDAAX,CAAN;AACD;;AAED,SAAO;AACLN,IAAAA,oBADK;AAELD,IAAAA,qBAFK;AAGLE,IAAAA;AAHK,GAAP;AAKD,CAdM;;;AAgBP,IAAIM,OAAO,GAAI,EAAf;AACA,IAAIC,OAAO,GAAI,EAAf;;AACA,MAAMC,UAAU,GAAG,CACjBC,cADiB,EAEjBC,KAFiB,EAGjBC,SAHiB,KAKjB,IAAIC,iBAAJ,CAAa,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAChC,MAAI,CAACZ,OAAO,CAACC,GAAR,CAAYY,2BAAb,IAA4CL,KAAK,KAAM,YAA3D,EAAwE;AACtE,0BAAQD,cAAR,EAAwBO,GAAxB,CAA4B,CAACC,GAAD,EAAMC,KAAN,KAAgB;AAC1C,UAAID,GAAJ,EAAS;AACP,eAAOH,MAAM,CAACG,GAAD,CAAb;AACD,OAFD,MAEO;AACL,eAAOJ,OAAO,CAACK,KAAD,CAAd;AACD;AACF,KAND;AAOD,GARD,MAQO,IACLhB,OAAO,CAACC,GAAR,CAAYY,2BAAZ,IACAL,KAAK,KAAM,cAFN,EAGL;AACAZ,IAAAA,qBAAqB,GAAG,sBAAQW,cAAR,CAAxB;AACAX,IAAAA,qBAAqB,CAACqB,KAAtB,CAA4BC,OAA5B,CAAoCC,GAApC,CAAyC,uBAAzC,EAAiEC,IAAI,IAAI;AACvEtB,MAAAA,wBAAwB,GAAG,IAA3B;AACD,KAFD;AAGAD,IAAAA,oBAAoB,GAAGD,qBAAqB,CAACyB,KAAtB,CACrB;AACEC,MAAAA,OAAO,EAAE;AADX,KADqB,EAIrB,CAACP,GAAD,EAAMC,KAAN,KAAgB;AACdlB,MAAAA,wBAAwB,GAAG,KAA3B;;AACAyB,qBAAQC,IAAR,CAAc,0BAAd;;AACA3B,MAAAA,oBAAoB,CAAC4B,OAArB;;AAEA,UAAIV,GAAJ,EAAS;AACP,eAAOH,MAAM,CAACG,GAAD,CAAb;AACD,OAFD,MAEO;AACLV,QAAAA,OAAO,GAAGW,KAAK,CAACU,IAAN,IAAe,EAAzB;;AAEA,cAAM;AACJC,UAAAA;AADI,YAEFC,OAAO,CAAE,kCAAF,CAFX,CAHK,CAML;;;AACA,YAAIxB,OAAO,KAAM,EAAb,IAAkBC,OAAO,KAAKD,OAAlC,EAA2C;AACzCuB,UAAAA,aAAa,CAAE,GAAElB,SAAU,wBAAd,CAAb;AACD;;AAEDL,QAAAA,OAAO,GAAGC,OAAV;AAEA,eAAOM,OAAO,CAACK,KAAD,CAAd;AACD;AACF,KA1BoB,CAAvB;AA4BD;AACF,CA9CD,CALF;;AAqDA,MAAMa,eAAe,GAAG,OACtB;AAAEpB,EAAAA;AAAF,CADsB,EAEtBqB,aAFsB,EAGtBtB,KAHsB,KAIF;AACpB,QAAMQ,KAAK,GAAG,MAAMV,UAAU,CAACwB,aAAD,EAAgBtB,KAAhB,EAAuBC,SAAvB,CAA9B;;AACA,MAAIO,KAAK,CAACe,SAAN,EAAJ,EAAuB;AACrBC,sBAASC,KAAT,CAAe,+CAAuBzB,KAAvB,EAA8BQ,KAAK,CAACkB,WAAN,CAAkBC,MAAhD,CAAf;AACD;;AAED,MACE3B,KAAK,KAAM,YAAX,IACA4B,aAAMC,QAAN,GAAiBC,IAAjB,CAAsBC,kBAAtB,KAA6CvB,KAAK,CAACU,IAFrD,EAGE;AACAU,iBAAMI,QAAN,CAAe;AACbC,MAAAA,IAAI,EAAG,kCADM;AAEbC,MAAAA,OAAO,EAAE1B,KAAK,CAACU;AAFF,KAAf;AAID,GAdmB,CAgBpB;;;AACA,SAAQ,GAAEjB,SAAU,wBAApB;AACD,CAtBD;;AAwBO,MAAMkC,aAAa,GAAG,OAC3BC,OAD2B,EAE3BpC,KAF2B,EAG3BqC,UAH2B,KAIP;AACpB,QAAM;AAAEpC,IAAAA;AAAF,MAAgBmC,OAAtB;AACA,QAAME,MAAM,GAAG,MAAM,uBAAcF,OAAd,EAAuBnC,SAAvB,EAAkCD,KAAlC,EAAyC,IAAzC,EAA+C;AAClEqC,IAAAA;AADkE,GAA/C,CAArB;AAIA,SAAOhB,eAAe,CAACe,OAAD,EAAUE,MAAV,EAAkBtC,KAAlB,CAAtB;AACD,CAXM;;;;AAaA,MAAMuC,cAAc,GAAG,MAAOC,YAAP,IAA+C;AAC3E,MAAI;AACF,UAAMC,iBAAGC,MAAH,CAAUF,YAAV,CAAN;AACA,UAAMC,iBAAGC,MAAH,CAAW,GAAEF,YAAa,MAA1B,CAAN;AACD,GAHD,CAGE,OAAOG,CAAP,EAAU,CACV;AACD;AACF,CAPM;;;;AAaP,MAAMC,eAAe,GAAG,OACtBC,UADsB,EAEtBC,QAFsB,EAGtBC,yBAHsB,EAItBC,KAJsB,EAKtBhD,KAAY,GAAGiD,aAAMC,SALC,KAMJ;AAClB;AACA;AACA,QAAMC,OAAO,GAAG,CACd,CAAE,UAAF,EAAa3D,OAAO,CAACC,GAAR,CAAY2D,QAAzB,CADc,EAEd,CAAE,0BAAF,EAA6B5D,OAAO,CAACC,GAAR,CAAYC,wBAAzC,CAFc,EAGd,CAAE,kBAAF,EAAqBF,OAAO,CAACC,GAAR,CAAY4D,gBAAjC,CAHc,CAAhB;AAMA,QAAMC,QAAQ,GAAG,mBAAMN,KAAN,EAAa,EAAb,CAAjB;AAEA,QAAMO,SAAS,GAAGC,IAAI,CAACC,GAAL,EAAlB;AAEA,QAAMC,UAAU,GACd1D,KAAK,KAAM,YAAX,GACI6C,UAAU,CAACc,cADf,GAEId,UAAU,CAACe,aAHjB;AAKA,QAAMC,6BAA6B,GAAG,IAAIC,GAAJ,EAAtC;;AAEA,MAAI;AACF,UAAM5D,kBAAS6D,GAAT,CAAaT,QAAb,EAAuB,MAAMU,WAAN,IAAqB;AAChD,YAAMC,cAAiC,GAAG,MAAMP,UAAU,CAAC;AACzDP,QAAAA,OADyD;AAEzDJ,QAAAA,yBAFyD;AAGzDmB,QAAAA,KAAK,EAAEF,WAHkD;AAIzDT,QAAAA;AAJyD,OAAD,CAA1D;;AAOA,UAAIvD,KAAK,KAAM,YAAf,EAA4B;AAC1B4B,qBAAMI,QAAN,CAAe;AACbC,UAAAA,IAAI,EAAG,gBADM;AAEbC,UAAAA,OAAO,EAAE8B;AAFI,SAAf;;AAKA,aAAK,MAAM,CAACG,SAAD,EAAYC,aAAZ,CAAX,IAAyCC,MAAM,CAACC,OAAP,CACvCL,cAAc,CAACM,6BADwB,CAAzC,EAEG;AACD,eAAK,MAAMC,gBAAX,IAA+BJ,aAA/B,EAA8C;AAC5CP,YAAAA,6BAA6B,CAACY,GAA9B,CAAkCD,gBAAlC;AACD;AACF;AACF;;AAED,UAAI1B,QAAQ,IAAIA,QAAQ,CAAC4B,IAAzB,EAA+B;AAC7B5B,QAAAA,QAAQ,CAAC4B,IAAT,CAAcV,WAAW,CAACW,MAA1B;AACD;AACF,KA1BK,CAAN;AA2BD,GA5BD,CA4BE,OAAOhC,CAAP,EAAU;AAAA;;AACV,QAAIA,CAAJ,aAAIA,CAAJ,6BAAIA,CAAC,CAAEiC,OAAP,uCAAI,WAAYL,6BAAhB,EAA+C;AAC7C,WAAK,MAAM,CAACJ,SAAD,EAAYC,aAAZ,CAAX,IAAyCC,MAAM,CAACC,OAAP,CACvC3B,CAAC,CAACiC,OAAF,CAAUL,6BAD6B,CAAzC,EAEG;AACD;AACA,aAAK,MAAMC,gBAAX,IAA+BJ,aAA/B,EAA8C;AAC5CP,UAAAA,6BAA6B,CAACY,GAA9B,CAAkCD,gBAAlC;AACD;AACF;AACF;;AACD,UAAM7B,CAAN;AACD,GAxCD,SAwCU;AACR,QAAIkB,6BAA6B,CAACgB,IAA9B,GAAqC,CAAzC,EAA4C;AAC1CC,MAAAA,OAAO,CAACC,IAAR,CACG,8EADH;;AAGAnD,mBAAMI,QAAN,CAAe;AACbC,QAAAA,IAAI,EAAG;AADM,OAAf;AAGD;;AAED,SAAK,MAAM+C,sBAAX,IAAqCnB,6BAArC,EAAoE;AAClE,YAAMoB,WAAW,GAAG,MAAM,mCACxBD,sBADwB,EAEvB,GAAEjC,yBAA0B,MAFL,CAA1B;AAKA,YAAMmC,cAAc,GAAI,GAAED,WAAW,CAACE,KAAM,GAC1CF,WAAW,CAACG,SAAZ,GAAyB,OAAMH,WAAW,CAACG,SAAU,IAArD,GAA4D,EAC7D,EAFD;;AAIA5D,wBAASuD,IAAT,CAAcG,cAAd;AACD;AACF;AACF,CAzFD;;AA2FA,MAAMG,cAAN,SAA6B1F,KAA7B,CAAmC;AAMjC2F,EAAAA,WAAW,CAACC,KAAD,EAAe;AACxB,UAAMA,KAAK,CAACC,OAAZ,EADwB,CAGxB;AACA;;AAJwB,SAL1BJ,SAK0B,GALb,EAKa;AAKxBf,IAAAA,MAAM,CAACoB,mBAAP,CAA2BF,KAA3B,EAAkCG,OAAlC,CAA0CC,GAAG,IAAI;AAC/C,WAAKA,GAAL,IAAYJ,KAAK,CAACI,GAAD,CAAjB;AACD,KAFD;AAGD;;AAdgC;;AAiB5B,MAAMC,YAAY,GAAG,OAC1BpD,YAD0B,EAE1BqD,SAF0B,EAG1B/C,QAH0B,EAI1BD,UAJ0B,EAK1B7C,KAL0B,KAMR;AAClB,MAAI;AACF,UAAM4C,eAAe,CAACC,UAAD,EAAaC,QAAb,EAAuBN,YAAvB,EAAqCqD,SAArC,EAAgD7F,KAAhD,CAArB;AACD,GAFD,CAEE,OAAOuF,KAAP,EAAc;AACd,UAAMN,WAAW,GAAG,MAAM,mCACxBM,KAAK,CAACJ,KADkB,EAEvB,GAAE3C,YAAa,MAFQ,CAA1B;AAIA,UAAMsD,UAAU,GAAG,IAAIT,cAAJ,CAAmBJ,WAAnB,CAAnB;AACAa,IAAAA,UAAU,CAAClB,OAAX,GAAqBW,KAAK,CAACX,OAA3B;AACA,UAAMkB,UAAN;AACD;AACF,CAlBM,C,CAoBP;;;;;AACO,MAAMC,SAAS,GAAG,OAAO;AAC9B3D,EAAAA,OAD8B;AAE9BpC,EAAAA,KAF8B;AAG9B6F,EAAAA,SAH8B;AAI9B/C,EAAAA,QAJ8B;AAK9BD,EAAAA;AAL8B,CAAP,KAYJ;AACnB,QAAML,YAAY,GAAG,MAAML,aAAa,CAACC,OAAD,EAAUpC,KAAV,EAAiB8C,QAAQ,CAACkD,IAA1B,CAAxC;AACA,QAAMJ,YAAY,CAACpD,YAAD,EAAeqD,SAAf,EAA0B/C,QAA1B,EAAoCD,UAApC,EAAgD7C,KAAhD,CAAlB;AACA,QAAMuC,cAAc,CAACC,YAAD,CAApB;AACD,CAhBM;;;;AAkBA,eAAeyD,qCAAf,CAAqD;AAC1DC,EAAAA,YAD0D;AAE1DrD,EAAAA,UAF0D;AAG1DsD,EAAAA,SAH0D;AAI1D/D,EAAAA;AAJ0D,CAArD,EAaJ;AACDgE,EAAAA,UAAU,CAACC,6CAAX;AAEA,QAAM;AACJC,IAAAA,YADI;AAEJC,IAAAA,QAFI;AAGJC,IAAAA;AAHI,MAIFJ,UAAU,CAACK,kBAAX,CAA8B7E,aAAMC,QAAN,EAA9B,CAJJ;;AAMAD,eAAMI,QAAN,CAAe;AACbC,IAAAA,IAAI,EAAG,4BADM;AAEbC,IAAAA,OAAO,EAAEsE;AAFI,GAAf;;AAKA,MAAIF,YAAY,CAAC3B,MAAb,GAAsB,CAA1B,EAA6B;AAC3B,UAAM+B,yBAAyB,GAAGlF,kBAASmF,cAAT,CAC/B,gCAD+B,EAEhCL,YAAY,CAAC3B,MAFmB,EAGhC,CAHgC,EAIhC;AACEtC,MAAAA,UAAU,EAAE8D;AADd,KAJgC,CAAlC;;AAQAO,IAAAA,yBAAyB,CAACE,KAA1B;;AACA,QAAI;AACF,YAAMhB,YAAY,CAChBM,YADgB,EAEhBI,YAFgB,EAGhBI,yBAHgB,EAIhB7D,UAJgB,EAKhBI,aAAMC,SALU,CAAlB;AAOD,KARD,CAQE,OAAO3C,GAAP,EAAY;AACZ,UAAIsG,EAAE,GAAI,OAAV,CADY,CACK;;AACjB,YAAMjC,OAAO,GAAG;AACdkC,QAAAA,SAAS,EAAEvG,GAAG,CAACqE,OAAJ,IAAerE,GAAG,CAACqE,OAAJ,CAAYmC,IADxB;AAEdC,QAAAA,GAAG,EAAG;AAFQ,OAAhB;AAKA,YAAMC,KAAK,GAAG1G,GAAG,CAACiF,OAAJ,CAAYyB,KAAZ,CACZ,yFADY,CAAd;;AAGA,UAAIA,KAAK,IAAIA,KAAK,CAAC,CAAD,CAAlB,EAAuB;AACrBJ,QAAAA,EAAE,GAAI,OAAN;AACAjC,QAAAA,OAAO,CAACoC,GAAR,GAAcC,KAAK,CAAC,CAAD,CAAnB;AACD;;AAEDP,MAAAA,yBAAyB,CAACjF,KAA1B,CAAgC;AAC9BoF,QAAAA,EAD8B;AAE9BjC,QAAAA,OAF8B;AAG9BW,QAAAA,KAAK,EAAEhF;AAHuB,OAAhC;AAKD;;AACDmG,IAAAA,yBAAyB,CAACQ,GAA1B;AACD,GAxCD,MAwCO;AACL1F,sBAAS2F,IAAT,CAAe,kDAAf;AACD;;AAED,MAAI,CAAC/E,OAAO,CAACgF,gBAAb,EAA+B;AAC7B,QAAI;AACF,YAAM7E,cAAc,CAAC2D,YAAD,CAApB;AACD,KAFD,CAEE,OAAO3F,GAAP,EAAY,CACZ;AACD;AACF;;AAED,MAAIgG,QAAQ,CAAC5B,MAAT,GAAkB,CAAtB,EAAyB;AACvB,UAAM0C,SAAS,GAAGN,IAAI,CAACO,IAAL,CAAUlF,OAAO,CAACnC,SAAlB,EAA8B,QAA9B,CAAlB;;AACA,UAAMsH,2BAA2B,GAAG/F,kBAASgG,aAAT,CACjC,2BADiC,CAApC;;AAGAD,IAAAA,2BAA2B,CAACX,KAA5B;AACA,UAAMR,UAAU,CAACqB,eAAX,CAA2BJ,SAA3B,EAAsCd,QAAtC,CAAN;AAEAgB,IAAAA,2BAA2B,CAACL,GAA5B;AACD;;AAED,SAAO;AAAEZ,IAAAA,YAAF;AAAgBC,IAAAA;AAAhB,GAAP;AACD","sourcesContent":["import Bluebird from \"bluebird\"\nimport fs from \"fs-extra\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { createErrorFromString } from \"gatsby-cli/lib/reporter/errors\"\nimport { chunk } from \"lodash\"\nimport webpack from \"webpack\"\nimport * as path from \"path\"\n\nimport { emitter, store } from \"../redux\"\nimport { IWebpackWatchingPauseResume } from \"../utils/start-server\"\nimport webpackConfig from \"../utils/webpack.config\"\nimport { structureWebpackErrors } from \"../utils/webpack-error-utils\"\nimport * as buildUtils from \"./build-utils\"\n\nimport { Span } from \"opentracing\"\nimport { IProgram, Stage } from \"./types\"\nimport { PackageJson } from \"../..\"\n\ntype IActivity = any // TODO\ntype IWorkerPool = any // TODO\n\nexport interface IBuildArgs extends IProgram {\n  directory: string\n  sitePackageJson: PackageJson\n  prefixPaths: boolean\n  noUglify: boolean\n  logPages: boolean\n  writeToFile: boolean\n  profile: boolean\n  graphqlTracing: boolean\n  openTracingConfigFile: string\n  keepPageRenderer: boolean\n}\n\nlet devssrWebpackCompiler: webpack.Compiler\nlet devssrWebpackWatcher: IWebpackWatchingPauseResume\nlet needToRecompileSSRBundle = true\nexport const getDevSSRWebpack = (): {\n  devssrWebpackWatcher: IWebpackWatchingPauseResume\n  devssrWebpackCompiler: webpack.Compiler\n  needToRecompileSSRBundle: boolean\n} => {\n  if (process.env.gatsby_executing_command !== `develop`) {\n    throw new Error(`This function can only be called in development`)\n  }\n\n  return {\n    devssrWebpackWatcher,\n    devssrWebpackCompiler,\n    needToRecompileSSRBundle,\n  }\n}\n\nlet oldHash = ``\nlet newHash = ``\nconst runWebpack = (\n  compilerConfig,\n  stage: Stage,\n  directory\n): Bluebird<webpack.Stats> =>\n  new Bluebird((resolve, reject) => {\n    if (!process.env.GATSBY_EXPERIMENTAL_DEV_SSR || stage === `build-html`) {\n      webpack(compilerConfig).run((err, stats) => {\n        if (err) {\n          return reject(err)\n        } else {\n          return resolve(stats)\n        }\n      })\n    } else if (\n      process.env.GATSBY_EXPERIMENTAL_DEV_SSR &&\n      stage === `develop-html`\n    ) {\n      devssrWebpackCompiler = webpack(compilerConfig)\n      devssrWebpackCompiler.hooks.invalid.tap(`ssr file invalidation`, file => {\n        needToRecompileSSRBundle = true\n      })\n      devssrWebpackWatcher = devssrWebpackCompiler.watch(\n        {\n          ignored: /node_modules/,\n        },\n        (err, stats) => {\n          needToRecompileSSRBundle = false\n          emitter.emit(`DEV_SSR_COMPILATION_DONE`)\n          devssrWebpackWatcher.suspend()\n\n          if (err) {\n            return reject(err)\n          } else {\n            newHash = stats.hash || ``\n\n            const {\n              restartWorker,\n            } = require(`../utils/dev-ssr/render-dev-html`)\n            // Make sure we use the latest version during development\n            if (oldHash !== `` && newHash !== oldHash) {\n              restartWorker(`${directory}/public/render-page.js`)\n            }\n\n            oldHash = newHash\n\n            return resolve(stats)\n          }\n        }\n      ) as IWebpackWatchingPauseResume\n    }\n  })\n\nconst doBuildRenderer = async (\n  { directory }: IProgram,\n  webpackConfig: webpack.Configuration,\n  stage: Stage\n): Promise<string> => {\n  const stats = await runWebpack(webpackConfig, stage, directory)\n  if (stats.hasErrors()) {\n    reporter.panic(structureWebpackErrors(stage, stats.compilation.errors))\n  }\n\n  if (\n    stage === `build-html` &&\n    store.getState().html.ssrCompilationHash !== stats.hash\n  ) {\n    store.dispatch({\n      type: `SET_SSR_WEBPACK_COMPILATION_HASH`,\n      payload: stats.hash,\n    })\n  }\n\n  // render-page.js is hard coded in webpack.config\n  return `${directory}/public/render-page.js`\n}\n\nexport const buildRenderer = async (\n  program: IProgram,\n  stage: Stage,\n  parentSpan?: IActivity\n): Promise<string> => {\n  const { directory } = program\n  const config = await webpackConfig(program, directory, stage, null, {\n    parentSpan,\n  })\n\n  return doBuildRenderer(program, config, stage)\n}\n\nexport const deleteRenderer = async (rendererPath: string): Promise<void> => {\n  try {\n    await fs.remove(rendererPath)\n    await fs.remove(`${rendererPath}.map`)\n  } catch (e) {\n    // This function will fail on Windows with no further consequences.\n  }\n}\n\nexport interface IRenderHtmlResult {\n  unsafeBuiltinsUsageByPagePath: Record<string, Array<string>>\n}\n\nconst renderHTMLQueue = async (\n  workerPool: IWorkerPool,\n  activity: IActivity,\n  htmlComponentRendererPath: string,\n  pages: Array<string>,\n  stage: Stage = Stage.BuildHTML\n): Promise<void> => {\n  // We need to only pass env vars that are set programmatically in gatsby-cli\n  // to child process. Other vars will be picked up from environment.\n  const envVars = [\n    [`NODE_ENV`, process.env.NODE_ENV],\n    [`gatsby_executing_command`, process.env.gatsby_executing_command],\n    [`gatsby_log_level`, process.env.gatsby_log_level],\n  ]\n\n  const segments = chunk(pages, 50)\n\n  const sessionId = Date.now()\n\n  const renderHTML =\n    stage === `build-html`\n      ? workerPool.renderHTMLProd\n      : workerPool.renderHTMLDev\n\n  const uniqueUnsafeBuiltinUsedStacks = new Set<string>()\n\n  try {\n    await Bluebird.map(segments, async pageSegment => {\n      const htmlRenderMeta: IRenderHtmlResult = await renderHTML({\n        envVars,\n        htmlComponentRendererPath,\n        paths: pageSegment,\n        sessionId,\n      })\n\n      if (stage === `build-html`) {\n        store.dispatch({\n          type: `HTML_GENERATED`,\n          payload: pageSegment,\n        })\n\n        for (const [_pagePath, arrayOfUsages] of Object.entries(\n          htmlRenderMeta.unsafeBuiltinsUsageByPagePath\n        )) {\n          for (const unsafeUsageStack of arrayOfUsages) {\n            uniqueUnsafeBuiltinUsedStacks.add(unsafeUsageStack)\n          }\n        }\n      }\n\n      if (activity && activity.tick) {\n        activity.tick(pageSegment.length)\n      }\n    })\n  } catch (e) {\n    if (e?.context?.unsafeBuiltinsUsageByPagePath) {\n      for (const [_pagePath, arrayOfUsages] of Object.entries(\n        e.context.unsafeBuiltinsUsageByPagePath\n      )) {\n        // @ts-ignore TS doesn't know arrayOfUsages is Iterable\n        for (const unsafeUsageStack of arrayOfUsages) {\n          uniqueUnsafeBuiltinUsedStacks.add(unsafeUsageStack)\n        }\n      }\n    }\n    throw e\n  } finally {\n    if (uniqueUnsafeBuiltinUsedStacks.size > 0) {\n      console.warn(\n        `Unsafe builtin method was used, future builds will need to rebuild all pages`\n      )\n      store.dispatch({\n        type: `SSR_USED_UNSAFE_BUILTIN`,\n      })\n    }\n\n    for (const unsafeBuiltinUsedStack of uniqueUnsafeBuiltinUsedStacks) {\n      const prettyError = await createErrorFromString(\n        unsafeBuiltinUsedStack,\n        `${htmlComponentRendererPath}.map`\n      )\n\n      const warningMessage = `${prettyError.stack}${\n        prettyError.codeFrame ? `\\n\\n${prettyError.codeFrame}\\n` : ``\n      }`\n\n      reporter.warn(warningMessage)\n    }\n  }\n}\n\nclass BuildHTMLError extends Error {\n  codeFrame = ``\n  context?: {\n    path: string\n  }\n\n  constructor(error: Error) {\n    super(error.message)\n\n    // We must use getOwnProperty because keys like `stack` are not enumerable,\n    // but we want to copy over the entire error\n    Object.getOwnPropertyNames(error).forEach(key => {\n      this[key] = error[key]\n    })\n  }\n}\n\nexport const doBuildPages = async (\n  rendererPath: string,\n  pagePaths: Array<string>,\n  activity: IActivity,\n  workerPool: IWorkerPool,\n  stage: Stage\n): Promise<void> => {\n  try {\n    await renderHTMLQueue(workerPool, activity, rendererPath, pagePaths, stage)\n  } catch (error) {\n    const prettyError = await createErrorFromString(\n      error.stack,\n      `${rendererPath}.map`\n    )\n    const buildError = new BuildHTMLError(prettyError)\n    buildError.context = error.context\n    throw buildError\n  }\n}\n\n// TODO remove in v4 - this could be a \"public\" api\nexport const buildHTML = async ({\n  program,\n  stage,\n  pagePaths,\n  activity,\n  workerPool,\n}: {\n  program: IProgram\n  stage: Stage\n  pagePaths: Array<string>\n  activity: IActivity\n  workerPool: IWorkerPool\n}): Promise<void> => {\n  const rendererPath = await buildRenderer(program, stage, activity.span)\n  await doBuildPages(rendererPath, pagePaths, activity, workerPool, stage)\n  await deleteRenderer(rendererPath)\n}\n\nexport async function buildHTMLPagesAndDeleteStaleArtifacts({\n  pageRenderer,\n  workerPool,\n  buildSpan,\n  program,\n}: {\n  pageRenderer: string\n  workerPool: IWorkerPool\n  buildSpan?: Span\n  program: IBuildArgs\n}): Promise<{\n  toRegenerate: Array<string>\n  toDelete: Array<string>\n}> {\n  buildUtils.markHtmlDirtyIfResultOfUsedStaticQueryChanged()\n\n  const {\n    toRegenerate,\n    toDelete,\n    toCleanupFromTrackedState,\n  } = buildUtils.calcDirtyHtmlFiles(store.getState())\n\n  store.dispatch({\n    type: `HTML_TRACKED_PAGES_CLEANUP`,\n    payload: toCleanupFromTrackedState,\n  })\n\n  if (toRegenerate.length > 0) {\n    const buildHTMLActivityProgress = reporter.createProgress(\n      `Building static HTML for pages`,\n      toRegenerate.length,\n      0,\n      {\n        parentSpan: buildSpan,\n      }\n    )\n    buildHTMLActivityProgress.start()\n    try {\n      await doBuildPages(\n        pageRenderer,\n        toRegenerate,\n        buildHTMLActivityProgress,\n        workerPool,\n        Stage.BuildHTML\n      )\n    } catch (err) {\n      let id = `95313` // TODO: verify error IDs exist\n      const context = {\n        errorPath: err.context && err.context.path,\n        ref: ``,\n      }\n\n      const match = err.message.match(\n        /ReferenceError: (window|document|localStorage|navigator|alert|location) is not defined/i\n      )\n      if (match && match[1]) {\n        id = `95312`\n        context.ref = match[1]\n      }\n\n      buildHTMLActivityProgress.panic({\n        id,\n        context,\n        error: err,\n      })\n    }\n    buildHTMLActivityProgress.end()\n  } else {\n    reporter.info(`There are no new or changed html files to build.`)\n  }\n\n  if (!program.keepPageRenderer) {\n    try {\n      await deleteRenderer(pageRenderer)\n    } catch (err) {\n      // pass through\n    }\n  }\n\n  if (toDelete.length > 0) {\n    const publicDir = path.join(program.directory, `public`)\n    const deletePageDataActivityTimer = reporter.activityTimer(\n      `Delete previous page data`\n    )\n    deletePageDataActivityTimer.start()\n    await buildUtils.removePageFiles(publicDir, toDelete)\n\n    deletePageDataActivityTimer.end()\n  }\n\n  return { toRegenerate, toDelete }\n}\n"],"file":"build-html.js"}